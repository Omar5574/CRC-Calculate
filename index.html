<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRC Lab V19.2 (Visual Enhancements)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Fira+Code:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --cell-size: 45px;
            --font-size: 20px;
            --arrow-size: 24px;
            --msb-top: -22px;
        }

        @media (max-width: 768px) {
            :root {
                --cell-size: 22px; 
                --font-size: 10px;
                --arrow-size: 12px;
                --msb-top: -14px;
            }
        }

        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        .font-mono { font-family: 'Fira Code', monospace; } 
        
        /* Container Logic */
        .simulation-container {
            background-color: #ffffff;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
            max-width: 100%;
            height: 60vh;
            overflow: hidden; 
        }

        .simulation-container.fullscreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 2000;
            border-radius: 0;
            height: 100dvh;
            width: 100vw;
            padding: 0;
            margin: 0;
            background-color: #fff;
        }

        /* Scroll Area */
        .sim-scroll-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto; 
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 80px;
        }

        /* Explanation Box */
        .doctor-note {
            width: 100%; max-width: 800px;
            background-color: #fffbeb; border-right: 4px solid #f59e0b;
            padding: 8px 12px; border-radius: 6px; margin-bottom: 15px;
            font-size: 0.9rem; color: #9a3412; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        /* Grid */
        .math-grid {
            display: grid; gap: 0px; direction: ltr; margin-bottom: 20px;
            flex-shrink: 0;
        }

        .cell {
            width: var(--cell-size); height: var(--cell-size); font-size: var(--font-size);
            display: flex; align-items: center; justify-content: center;
            font-family: 'Fira Code', monospace; font-weight: 700;
            color: #334155; position: relative;
        }

        /* Cell Types */
        .cell.quotient { color: #64748b; font-size: calc(var(--font-size) * 0.9); border-bottom: none; }
        .cell.dividend { background-color: #f8fafc; border-top: 2px solid #1e2937; border-bottom: none; }
        .cell.divisor { color: #0f172a; font-weight: 900; }
        .cell.subtrahend { color: #475569; }
        .cell.line { border-bottom: 2px solid #1e2937; height: 50%; align-self: start; }
        .cell.result { color: #0f172a; font-weight: 800; background-color: #f0f9ff; }
        
        /* New Coloring for Added Bits */
        .cell.dropped { 
            color: #1e40af; /* Darker Blue */
            font-weight: 900; 
            background-color: #dbeafe; /* Light Blue BG */
            border: 1px dashed #3b82f6; 
            border-radius: 4px; 
        } 
        
        .cell.padding { 
            color: #2563eb; 
            font-weight: 900; 
            background-color: #eff6ff; 
            border-bottom: 2px solid #bfdbfe; 
        } 
        
        .cell.arrow { color: #ef4444; font-size: var(--arrow-size); font-weight: 900; z-index: 20; animation: bounceArrow 1s infinite; }
        
        /* Enhanced MSB Indicator */
        .msb-indicator {
            position: absolute; top: var(--msb-top); left: 50%; transform: translateX(-50%);
            background-color: #f59e0b; color: white; padding: 1px 4px;
            border-radius: 3px; font-size: 8px; font-weight: 800; white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15); z-index: 60; animation: fadeIn 0.3s;
            border: 1px solid #d97706;
        }
        .msb-indicator::after {
            content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%);
            border-width: 4px 4px 0; border-style: solid; border-color: #f59e0b transparent transparent transparent;
        }

        @keyframes bounceArrow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -5px); } to { opacity: 1; transform: translate(-50%, 0); } }

        .bracket-wall { border-right: 2px solid #1e2937; height: 100%; position: absolute; right: 0; top: 0; z-index: 5; }

        /* Integrated Result */
        .result-panel {
            width: 100%; max-width: 900px;
            background-color: #f0fdf4; border: 2px solid #bbf7d0;
            border-radius: 12px; margin-top: 10px; padding: 10px;
            display: flex; flex-wrap: wrap; gap: 10px;
            align-items: stretch; flex-shrink: 0;
        }

        .res-card {
            flex: 1; min-width: 140px; background: white;
            border-radius: 8px; padding: 8px; text-align: center;
            border: 1px solid #dcfce7; display: flex;
            flex-direction: column; justify-content: center;
        }

        .res-title { font-size: 0.7rem; color: #166534; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; }
        .res-val { font-family: 'Fira Code', monospace; font-weight: 700; color: #15803d; font-size: 1.1rem; word-break: break-all; }
        .res-card.highlight { background-color: #dcfce7; border-color: #86efac; }
        .res-card.highlight .res-val { font-size: 1.3rem; color: #14532d; }

        /* Controls */
        .controls-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(8px);
            padding: 8px 12px; box-shadow: 0 -4px 15px rgba(0,0,0,0.05);
            z-index: 3000; display: flex; justify-content: space-between; align-items: center; 
            border-top: 1px solid #e2e8f0; gap: 8px;
        }

        .fs-btn {
            position: absolute; top: 10px; left: 10px; z-index: 50;
            background: #fff; border: 1px solid #cbd5e1;
            padding: 4px 8px; border-radius: 4px; font-size: 11px;
            cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 4px;
        }

        /* Rx Mode */
        body.rx-active .cell.padding { color: #059669; background-color: #ecfdf5; border-color: #6ee7b7; }
        body.rx-active .msb-indicator { background-color: #059669; border-color: #047857; }
        body.rx-active .msb-indicator::after { border-color: #059669 transparent transparent transparent; }
    </style>
</head>
<body class="pb-32 md:pb-40">

    <!-- Header -->
    <header class="bg-slate-900 text-white py-3 px-4 shadow-lg sticky top-0 z-40">
        <div class="flex flex-col md:flex-row justify-between items-center gap-3">
            <div class="flex items-center justify-between w-full md:w-auto">
                <h1 class="text-lg md:text-2xl font-bold text-yellow-400 font-mono tracking-wider">CRC Lab V19.2</h1>
            </div>
            
            <div class="flex bg-slate-800 rounded-lg p-1 text-xs border border-slate-700 w-full md:w-auto justify-center">
                <button onclick="setMode('tx')" id="tabTx" class="flex-1 md:flex-none px-4 py-2 rounded-md font-bold transition flex gap-2 items-center justify-center bg-blue-600 text-white shadow-md">
                    <span>ğŸ“¡</span> Tx
                </button>
                <button onclick="setMode('rx')" id="tabRx" class="flex-1 md:flex-none px-4 py-2 rounded-md transition flex gap-2 items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700">
                    <span>ğŸ“¥</span> Rx
                </button>
            </div>
        </div>
    </header>

    <main class="w-full px-3 md:px-8 py-4 space-y-4">

        <!-- Input Area -->
        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
            <div class="md:col-span-5">
                <label class="text-xs font-bold text-slate-500 uppercase block mb-1" id="labelData">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data)</label>
                <input type="text" id="inData" value="1010001101" class="w-full p-2 border-2 border-slate-200 rounded-lg font-mono text-center font-bold text-base focus:border-blue-500 outline-none transition text-slate-700">
            </div>
            <div class="md:col-span-4">
                <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Ø§Ù„Ù†Ù…Ø· (Pattern)</label>
                <input type="text" id="inPoly" value="110101" class="w-full p-2 border-2 border-slate-200 rounded-lg font-mono text-center font-bold text-base focus:border-blue-500 outline-none transition text-slate-700">
            </div>
            
            <div class="md:col-span-3 flex gap-2">
                <div id="rxTools" class="hidden flex-1">
                    <button onclick="injectError()" class="w-full bg-red-50 text-red-600 border border-red-200 px-2 py-2 rounded-lg font-bold hover:bg-red-100 transition h-[42px] flex items-center justify-center gap-1 text-xs">
                        <span>âš¡</span> ØªØ´ÙˆÙŠØ´
                    </button>
                </div>

                <button onclick="resetSim()" class="flex-1 bg-slate-800 text-white px-4 py-2 rounded-lg font-bold hover:bg-slate-900 transition shadow-lg transform active:scale-95 flex items-center justify-center gap-2 text-xs md:text-sm h-[42px]">
                    <span>ğŸ”„</span> <span>Ø§Ø¨Ø¯Ø£</span>
                </button>
            </div>
        </div>

        <!-- The Unified Simulation Container -->
        <div class="simulation-container" id="simContainer">
            <button onclick="toggleFullScreen()" class="fs-btn" title="Full Screen">
                <span>â¤¢</span> ØªÙƒØ¨ÙŠØ±
            </button>
            
            <!-- Scrollable Area -->
            <div class="sim-scroll-area">
                
                <!-- Explanation -->
                <div class="doctor-note fade-in" id="doctorBox">
                    <strong>ğŸ‘¨â€ğŸ« Ø§Ù„Ø´Ø±Ø­:</strong> <span id="explainText">Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£" Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</span>
                </div>

                <!-- Math Board -->
                <div id="mathBoard" class="math-grid"></div>

                <!-- Integrated Result (Side by Side) -->
                <div id="integratedResult" class="result-panel hidden">
                    <!-- CRC Result -->
                    <div class="res-card highlight">
                        <div class="res-title" id="resTitle">Ø§Ù„Ù†ØªÙŠØ¬Ø© (FCS)</div>
                        <div class="res-val" id="finalFCS">0000</div>
                    </div>
                    <!-- Transmitted Data -->
                    <div class="res-card">
                        <div class="res-title" id="msgTitle">Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø©</div>
                        <div class="res-val text-sm" id="finalMsg">...</div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Bottom Controls -->
    <div class="controls-bar flex-col md:flex-row gap-2">
        <div class="flex w-full md:w-auto gap-2">
            <button onclick="prevStep()" id="btnPrev" disabled class="flex-1 md:flex-none bg-slate-100 text-slate-500 hover:bg-slate-200 px-4 py-2 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2 disabled:opacity-40 border border-slate-300">
                <span>â¬…ï¸</span> Ø³Ø§Ø¨Ù‚
            </button>
            
            <button onclick="nextStep()" id="btnNext" disabled class="flex-[2] md:flex-none bg-blue-600 text-white hover:bg-blue-700 px-6 py-2 rounded-lg font-bold text-base shadow-xl transition flex items-center justify-center gap-2 disabled:bg-slate-300 disabled:cursor-not-allowed transform active:scale-[0.98]">
                <span id="btnNextText">Ø§Ù„ØªØ§Ù„ÙŠ</span> <span>â¡ï¸</span>
            </button>
        </div>
    </div>

    <script>
        // --- State ---
        let mode = 'tx';
        let queue = [];
        let cursor = 0;
        let historyStack = [];
        let isFullScreen = false;

        // --- Logic ---
        function planSteps(data, poly) {
            let q = [];
            let paddingCount = (mode === 'tx') ? poly.length - 1 : 0;
            let fullDividend = data + '0'.repeat(paddingCount);
            let dividendArr = fullDividend.split('');
            let polyLen = poly.length;
            
            const totalCols = polyLen + 1 + fullDividend.length;
            
            q.push({
                op: 'setup', data, poly, padded: fullDividend, padding: paddingCount, 
                startCol: polyLen + 1, totalCols: totalCols,
                explain: (mode === 'tx') 
                    ? `<strong>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</strong> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª + <span class="text-blue-600 font-bold">${paddingCount} Ø£ØµÙØ§Ø± Ø²Ø±Ù‚Ø§Ø¡</span>.`
                    : `<strong>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</strong> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„Ø©.`
            });

            let currentWindow = dividendArr.slice(0, polyLen);
            let nextBitPointer = polyLen; 
            let currentRow = 2; 
            let currentCol = polyLen + 1; 

            while (true) {
                let msb = currentWindow[0];
                let workRow = currentRow + 1;

                q.push({
                    op: 'quotient', val: (msb === '1' ? '1' : '0'), col: currentCol,
                    explain: (msb === '1') ? `Ø§Ù„Ù€ <strong>MSB=1</strong> â† Ø§Ù„Ù†Ø§ØªØ¬ ÙÙˆÙ‚ 1.` : `Ø§Ù„Ù€ <strong>MSB=0</strong> â† Ø§Ù„Ù†Ø§ØªØ¬ ÙÙˆÙ‚ 0.`
                });

                if (msb === '0') {
                    if (nextBitPointer < dividendArr.length) {
                        let nextBit = dividendArr[nextBitPointer];
                        let newWindow = currentWindow.slice(1);
                        newWindow.push(nextBit);
                        
                        currentCol++; 
                        
                        q.push({
                            op: 'rewrite_pattern',
                            pattern: newWindow,
                            row: workRow, 
                            col: currentCol,
                            newBitVal: nextBit,
                            msbCol: currentCol, 
                            explain: `Ø§Ù„Ù€ <strong>MSB=0</strong>: Ù‡Ù†Ø±Ø­Ù„ ÙˆÙ†Ù†Ø²Ù„ Ø§Ù„Ø±Ù‚Ù… <strong>(${nextBit})</strong>.<br>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: <code>${newWindow.join('')}</code>.`
                        });
                        
                        currentWindow = newWindow;
                        nextBitPointer++;
                        currentRow += 1; 
                        
                    } else {
                        q.push({ op: 'info', explain: "Ø§Ù„Ù€ MSB Ø¨ØµÙØ± ÙˆÙ…ÙÙŠØ´ Ø£Ø±Ù‚Ø§Ù… ØªØ§Ù†ÙŠ. Ø®Ù„ØµÙ†Ø§." });
                        break;
                    }

                } else {
                    q.push({
                        op: 'subtrahend', val: poly, row: workRow, col: currentCol,
                        msbCol: currentCol,
                        explain: `Ø§Ù„Ù€ <strong>MSB=1</strong>: Ù†ÙƒØªØ¨ <code>${poly}</code> ÙˆÙ†Ø¹Ù…Ù„ XOR.`
                    });

                    q.push({
                        op: 'line', len: polyLen, row: workRow + 1, col: currentCol
                    });

                    let xorResult = [];
                    for(let k=0; k<polyLen; k++) xorResult.push(currentWindow[k] === poly[k] ? '0' : '1');
                    
                    let newWindow = xorResult.slice(1); 
                    
                    if (nextBitPointer < dividendArr.length) {
                        let nextBit = dividendArr[nextBitPointer];
                        newWindow.push(nextBit);
                        
                        currentCol++; 
                        
                        q.push({
                            op: 'rewrite_pattern',
                            pattern: newWindow,
                            row: workRow + 2,
                            col: currentCol,
                            newBitVal: nextBit,
                            msbCol: currentCol,
                            explain: `Ø§Ù„Ù†Ø§ØªØ¬ XOR Ù‡Ùˆ <code>${xorResult.slice(1).join('')}</code>.<br>Ù†Ø²Ù„Ù†Ø§ Ø¹Ù„ÙŠÙ‡ <strong>${nextBit}</strong>.<br>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: <code>${newWindow.join('')}</code>.`
                        });
                        
                        currentWindow = newWindow;
                        nextBitPointer++;
                        currentRow += 3; 

                    } else {
                        currentWindow = xorResult.slice(1);
                        q.push({
                            op: 'result_final', val: currentWindow.join(''), 
                            row: workRow+2, col: currentCol + 1, 
                            explain: `Ø®Ù„ØµÙ†Ø§! Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù‡Ùˆ.`
                        });
                        break;
                    }
                }
            }

            let finalCRC = currentWindow.slice(currentWindow.length - (polyLen - 1)).join('');
            return { q, finalCRC, totalCols };
        }

        // --- Drawing ---
        function draw(step) {
            const board = document.getElementById('mathBoard');
            let addedElements = [];
            const addEl = (el) => { board.appendChild(el); addedElements.push(el); };

            if(step.op === 'setup') {
                board.style.gridTemplateColumns = `repeat(${step.totalCols + 2}, var(--cell-size))`;
                for(let i=0; i<step.poly.length; i++) addEl(createCell(2, 1+i, step.poly[i], 'divisor'));
                let bracket = createCell(2, step.poly.length, '', 'bracket');
                bracket.appendChild(createWall());
                addEl(bracket);
                for(let i=0; i<step.padded.length; i++) {
                    let type = (mode === 'tx' && i >= step.padded.length - step.padding) ? 'padding' : 'dividend';
                    if (mode === 'rx' && i >= step.padded.length - (step.poly.length - 1)) type = 'padding';
                    let c = createCell(2, step.startCol+i, step.padded[i], type);
                    if(i===0) addMSB(c);
                    addEl(c);
                }
                document.body.className = (mode==='rx') ? 'rx-active' : '';
            }
            else if(step.op === 'quotient') {
                addEl(createCell(1, step.col, step.val, 'quotient'));
            }
            else if(step.op === 'subtrahend') {
                for(let i=0; i<step.val.length; i++) addEl(createCell(step.row, step.col+i, step.val[i], 'subtrahend'));
            }
            else if(step.op === 'line') {
                for(let i=0; i<step.len; i++) addEl(createCell(step.row, step.col+i, '', 'line'));
            }
            else if(step.op === 'rewrite_pattern') {
                step.pattern.forEach((bit, idx) => {
                    let isNew = (idx === step.pattern.length - 1);
                    let type = isNew ? 'pattern new-bit dropped' : 'pattern'; // Use 'dropped' class for new bit
                    let c = createCell(step.row, step.col+idx, bit, type);
                    if(idx===0) addMSB(c); 
                    addEl(c);
                });
            }
            else if(step.op === 'result_final') {
                for(let i=0; i<step.val.length; i++) addEl(createCell(step.row, step.col+i, step.val[i], 'result'));
            }
            
            if(cursor === queue.length - 1) showResults(window.finalRes);
            return addedElements;
        }

        function createCell(row, col, text, type) {
            const div = document.createElement('div');
            div.className = `cell ${type}`;
            div.style.gridRow = row;
            div.style.gridColumn = col;
            div.innerText = text;
            return div;
        }

        function createWall() {
            const d = document.createElement('div');
            d.className = 'bracket-wall';
            return d;
        }

        function addMSB(cell) {
            const m = document.createElement('div');
            m.className = 'msb-indicator';
            m.innerText = 'MSB';
            cell.appendChild(m);
            cell.style.overflow = 'visible';
        }

        function toggleFullScreen() {
            const wrapper = document.getElementById('simContainer'); // Target the Main Wrapper
            const btn = wrapper.querySelector('.fs-btn span');
            isFullScreen = !isFullScreen;
            
            if (isFullScreen) {
                wrapper.classList.add('fullscreen');
                btn.innerText = 'â¤“'; 
                document.body.style.overflow = 'hidden';
            } else {
                wrapper.classList.remove('fullscreen');
                btn.innerText = 'â¤¢'; 
                document.body.style.overflow = 'auto';
            }
        }

        function setMode(m) {
            mode = m;
            
            const activeStyle = "flex-1 md:flex-none px-4 py-2 rounded-md font-bold transition flex gap-2 items-center justify-center bg-blue-600 text-white shadow-md";
            const inactiveStyle = "flex-1 md:flex-none px-4 py-2 rounded-md transition flex gap-2 items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700";
            
            document.getElementById('tabTx').className = (m === 'tx') ? activeStyle : inactiveStyle;
            document.getElementById('tabRx').className = (m === 'rx') ? activeStyle : inactiveStyle;

            const labelEl = document.getElementById('labelData');
            if(labelEl) labelEl.innerText = (m==='tx') ? "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data)" : "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„Ø©";
            
            if(m==='rx') {
                document.getElementById('rxTools').classList.remove('hidden');
                document.getElementById('inData').value = '101000110101110'; 
            } else {
                document.getElementById('rxTools').classList.add('hidden');
                document.getElementById('inData').value = '1010001101';
            }
            document.getElementById('inPoly').value = '110101';
            resetSim();
        }

        function injectError() {
            let val = document.getElementById('inData').value.split('');
            let idx = Math.floor(Math.random()*val.length);
            val[idx] = val[idx] === '0' ? '1' : '0';
            document.getElementById('inData').value = val.join('');
            resetSim();
            document.getElementById('explainText').innerHTML = `<span class="text-red-600 font-bold">âš ï¸ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Øª Ø±Ù‚Ù… ${idx+1}!</span>`;
        }

        function resetSim() {
            const d = document.getElementById('inData').value;
            const p = document.getElementById('inPoly').value;
            if(!d || p.length < 2) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");

            document.getElementById('mathBoard').innerHTML = '';
            document.getElementById('integratedResult').classList.add('hidden'); 

            const plan = planSteps(d, p);
            queue = plan.q;
            window.finalRes = plan.finalCRC;
            cursor = 0;
            historyStack = [];

            document.getElementById('btnNext').disabled = false;
            document.getElementById('btnPrev').disabled = true;
            document.getElementById('btnNextText').innerText = "Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©";

            nextStep(); 
        }

        function nextStep() {
            if(cursor >= queue.length) return;
            const step = queue[cursor];
            const els = draw(step);
            historyStack.push(els);
            if(step.explain) document.getElementById('explainText').innerHTML = step.explain;
            cursor++;
            updateButtons();
            
            // Scroll inside the new wrapper structure
            const scrollArea = document.querySelector('.sim-scroll-area');
            if(scrollArea) scrollArea.scrollTop = scrollArea.scrollHeight;
        }

        function prevStep() {
            if(cursor <= 1) return; 
            cursor--;
            const lastEls = historyStack.pop();
            lastEls.forEach(el => el.remove());
            const prevStep = queue[cursor-1];
            if(prevStep && prevStep.explain) document.getElementById('explainText').innerHTML = prevStep.explain;
            document.getElementById('integratedResult').classList.add('hidden');
            updateButtons();
        }

        function updateButtons() {
            document.getElementById('btnPrev').disabled = (cursor <= 1);
            const nextBtn = document.getElementById('btnNext');
            if(cursor >= queue.length) {
                nextBtn.disabled = true;
                document.getElementById('btnNextText').innerText = "ØªÙ… Ø§Ù„Ø­Ù„";
            } else {
                nextBtn.disabled = false;
                document.getElementById('btnNextText').innerText = "Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©";
            }
        }

        function showResults(crc) {
            // Show Integrated Result
            const resBox = document.getElementById('integratedResult');
            resBox.classList.remove('hidden');
            
            const title = document.getElementById('resTitle');
            const val = document.getElementById('finalFCS');
            const msgTitle = document.getElementById('msgTitle');
            const msgVal = document.getElementById('finalMsg');
            
            val.innerText = crc;
            
            if(mode === 'tx') {
                title.innerText = "âœ… Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©";
                msgTitle.innerText = "Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø© (Data + CRC)";
                msgVal.innerHTML = `${document.getElementById('inData').value}<span class="text-blue-600 font-bold">${crc}</span>`;
            } else {
                let isZero = parseInt(crc) === 0;
                title.innerText = isZero ? "ğŸ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø³Ù„ÙŠÙ…Ø©" : "âš ï¸ Ø®Ø·Ø£ (Error)";
                msgTitle.innerText = "Ø§Ù„Ø­Ø§Ù„Ø©";
                msgVal.innerHTML = isZero ? "Ø§Ù„Ø¨Ø§Ù‚ÙŠ ØµÙØ± = ØªÙ…Ø§Ù…" : "Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ù…Ø´ ØµÙØ± = Ø§Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„";
                msgVal.className = isZero ? "res-val text-sm text-emerald-600" : "res-val text-sm text-red-600";
            }
            
            const scrollArea = document.querySelector('.sim-scroll-area');
            if(scrollArea) scrollArea.scrollTop = scrollArea.scrollHeight;
        }
        
        resetSim();

    </script>
</body>
</html>
